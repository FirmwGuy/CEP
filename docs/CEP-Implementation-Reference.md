# CEP Implementation Reference

## Introduction
This document condenses every implementation-relevant rule and guarantee scattered across `docs/`, focusing on the shipped Layer 0 kernel and the planned layers that influence its surface. It omits build and tooling instructions and removes narrative devices so an automated agent can reason directly from the deterministic contracts.

## Technical Details

### Layer scope and adoption order
- CEP’s layers progress from the shipping kernel (Layer 0) through coherence packs (Layer 1), the deterministic Flow VM (Layer 2), awareness (Layer 3), and governance/culture (Layer 4). Only Layer 0 ships in this repository; higher layers remain planned but their invariants (Decision Cells for non-deterministic choices, Facet closure, policy-driven governance) inform the kernel contracts.
- Beats are strictly Capture → Compute → Commit. Inputs for beat *N* are frozen during Capture, work stages during Compute, and results become visible at beat *N+1*. Every non-deterministic choice must emit a Decision Cell so replays consume recorded decisions instead of re-executing randomness.
- Minimal adoption sequence: start with the kernel/heartbeat, add coherence (Beings/Bonds/Contexts) when identities matter, then the Flow VM (Guard/Transform/Wait/Decide/Clamp primitives plus Variants/Niches/Guardians), perspectives/interpretations for awareness, and finally governance packs (Laws/Reforms/Councils/Provinces) and culture (Stories/Legends tethered to evidence).
- Layer 1 ensures adjacency closure: contexts tie multiple beings with role-typed positions and automatically materialize required facets or record debts; adjacency mirrors accelerate local queries while `/data/coh/*` stays authoritative.
- Observability remains integral: provenance links every derived fact to sources, guard predicates, code identities, and council approvals. Replay can re-run any beat range with Decision Cells to ensure equality, and summarization layers (Perspectives, Interpretations, Conventions, Summaries) build incremental awareness artifacts.
- Privacy relies on payload-level cryptography with per-subject keys; erasure drops keys while keeping structural stubs, and redaction cells can provide reversible masking. Scale is horizontal via partitions exchanging serialized deltas rather than global barriers; occasional sync pulses align summaries.

### Domain/Tag naming, lexicon, and glob rules
- `cepDT` stores 58-bit domain and tag identifiers. Layer 0 defaults to the `CEP` domain; tags are lowercase “words” up to 11 characters drawn from `[a-z0-9:_-.]`. Acronyms allow up to 9 printable ASCII characters (0x20–0x5F). `*` marks globbing segments and is only valid when the runtime sets the glob bit.
- `CEP-TAG-LEXICON.md` enumerates canonical tags for runtime roots, heartbeat artifacts, transports, and harness fixtures. Extend it before minting new identifiers so tooling (lexicon checkers) can spot unused tags.
- Glob semantics: a globbed tag matches zero or more characters within the segment; domains still use dedicated sentinel IDs. Literal cell names must not contain glob characters; globbing is reserved for queries (enzyme descriptors, traversal filters). Serialization persists the glob bit so replay does not recompute intent.
- The namepool interns longer or user-provided identifiers; reference IDs are append-only and replayed deterministically. Use `cep_namepool_intern_pattern*` when the stored string should behave as a glob. Release dynamic entries when modules unload to prevent pool growth.

### Data model, stores, history, and traversal
- Cells carry metadata, optional payload (`cepData`), and optional child stores (`cepStore`). Append-only timelines apply independently to payloads and stores. Each mutation records a `modified` beat, and past entries chain backwards to keep history O(1) per write. Duplicate payloads or structural no-ops short-circuit updates.
- Stores are pluggable (linked list, array, packed queue, red-black tree, hash table, octree) and pair with indexing modes (insertion, by name, by comparator, by hash, by function). Choose storage and indexing per workload; avoid unnecessary reindexing because each snapshot captures a full layout history.
- Locks prevent concurrent mutations: `cep_store_lock`/`unlock` gates structure, `cep_data_lock`/`unlock` gates payloads, and locks propagate up the ancestor chain. Immutable branches (`cep_cell_set_immutable`, `cep_branch_seal_immutable`) reject mutations outright.
- Links resolve to non-link targets and maintain backlink “shadows” so targets cannot finalize while referenced. Tombstone propagation marks linkers when targets are deleted. Link cycles remain disallowed.
- Raw traversal helpers (`cep_cell_*_all`) expose veiled and deleted children without visibility filters, enabling sealing/digesting routines to inspect every stored child.
- `cep_cell_add` insists on an active RW lease (`cep_ep_require_rw()`); rejected attempts immediately finalize floating children so callers do not leak scratch nodes, and successful inserts copy the parent store’s `modified` beat into the child’s `created` timestamp when the parent is already published. Treat add failures as destructive for the supplied scratch cell.
- Provenance buckets live under `meta/parents`: callers toggle the `meta` dictionary/list stores writable, hard-delete previous entries, and append link cells tagged with `parent` to capture each source. The helper enforces normal-cell targets and refuses immutable nodes.
- `cep_cell_initialize_clone` only mirrors metadata for empty template shells: the source must lack payloads and child stores, so use the helper strictly to seed shape-identical containers before running specialised clone routines.
- Root layout is fixed: `/sys` (lifecycle state), `/rt` (beat journals, ops, analytics), `/journal` (effect logs), `/env` (handles), `/cas` (content-addressable blobs), `/lib` (library snapshots), `/data` (durable state promoted at commit), `/tmp` (scratch), `/enzymes` (registry manifests). Heartbeat policy optionally creates `/rt/beat/<n>/` directories containing `impulses`, `meta/unix_ts_ns`, `agenda`, and `stage`.

### Payload representations and external resources
- Payload kinds: `VALUE` (inline bytes, best for ≤64 B), `DATA` (heap buffer, optional destructor, `swap=true` for zero-copy), `HANDLE` (opaque reference managed by adapters), `STREAM` (windowed I/O). Only `VALUE`/`DATA` expose direct buffers; handles and streams must use adapter APIs.
- Native types treat all bytes as opaque; canonicalization (endianness, UTF‑8, vector layouts) lives in enzymes. Hashes combine domain, tag, size, and bytes for deterministic indexing.
- Proxies wrap external resources. Adapters implement retain/release, snapshot/restore, and stream read/write/map hooks. Serialization emits proxy chunks (`class 0x0003`); adapters refusing snapshots must abort serialization explicitly. Deep clones of HANDLE/STREAM nodes become links to avoid duplicating resources.
- External library access is mediated by adapter vtables. CEP never touches foreign structs directly; deterministic work requires either a snapshot (bytes stored in a cell) or a read-only borrowed view that obeys strict lifetime guarantees. Mutations against external systems must supply preconditions (hash, version, ETag) and record intent/outcome pairs in the journal.
- I/O effect logging: every read/write captures offset, length, hash, expected version, idempotency key, and result. Large transfers rely on windowing plus optional checkpoints; replays can simulate (no side effects) or re-apply (verify preconditions before touching the world).
- Library bindings are DATA payloads typed as `library` cells; they own refcounted adapters whose destructor marks the binding “destroying” before releasing the context. HANDLE/STREAM reads or writes append `stream-log` VALUE entries under a lazily created `journal` list child on the owning resource, capturing offsets, requested/actual byte counts, hashes, flags, and a beat-derived Unix timestamp so traces stay deterministic.

### Deterministic runtime, enzymes, and episodes
- Heartbeat plumbing (`cep_heartbeat_*`) enforces beat phases, records impulses under `/rt/beat/<n>/impulses`, logs agenda execution, and writes commit notes. Impulses log both signal and target paths. Beat timestamps land in `/rt/beat/<n>/meta/unix_ts_ns` and analytics capture spacing deltas.
- Enzyme descriptors (`cep_enzyme_register`) define callbacks, match policy (exact or prefix), dependency lists, labels, and idempotency flags. Cell bindings (`cep_cell_bind_enzyme`) attach descriptors to subtrees with optional propagation; tombstones mask inherited bindings. Signal-only dispatch reuses registry indexes with literal buckets plus wildcard head lists.
- Dispatch resolves bindings along the target ancestry, intersects with signal matches, performs specificity and dependency ordering, and topologically sorts the agenda. Pending registrations activate on the next beat to keep agendas stable.
- Cell-operation enzymes (`sig_cell/op_*`) provide stock add/update/delete/move/clone verbs operating on request dictionaries containing role links (`role_parent`, `role_subject`, `role_source`, `role_templ`) plus optional arguments (`arg_deep`, `arg_prepend`, `arg_pos`).
- The Episodic Enzyme Engine (E³) tracks long-running work as `op/ep` dossiers. Episodes run slices under policies (RO, RW, hybrid), use TLS contexts for budgets and cancellation, and require leases for mutations. Yield (`cep_ep_yield`) and await (`cep_ep_await`) state transitions are recorded in OPS history. RW promotions acquire leases before mutating; demotions enforce lease release. Budget overruns emit `ep:bud/*` CEI facts and flip cancellation flags.
- Pause/Rollback/Resume controls gate heartbeat agendas: pause acquires locks and parks impulses in `/data/mailbox/impulses`, rollback rewinds the published `view_hzn`, and resume drains the backlog in deterministic order. Only control impulses and CEI continue while gating is active.
- Debug macros: wrap instrumentation in `CEP_DEBUG`, guard invariants with `CEP_ASSERT`/`CEP_NOT_ASSERT`, and avoid placing required logic inside debug-only blocks so release builds stay correct.

### Lifecycle operations, bootstrap, and packs
- `cep_l0_bootstrap()` initializes cells, the heartbeat, and namepool, then publishes `op/boot` states (`ist:kernel`, `ist:store`, `ist:packs`, `sts:ok`). `cep_heartbeat_emit_shutdown()` mirrors the process for `op/shdn` (`ist:stop`, `ist:flush`, `ist:halt`, `sts:ok`). `cep_op_await()` attaches beat-counted watchers that enqueue continuations via `op/cont` or `op/tmo` during stage commit.
- Upper-layer packs must bootstrap as optional plugins: probe prerequisites, register enzymes idempotently, publish readiness evidence through pack-owned ops or branches, and shut down cleanly. Kernel code must succeed with zero packs present.
- Organs describe typed subtrees with validator, constructor, and destructor enzymes. Descriptors live under `/sys/organs/<kind>/spec/` and are immutable. Validators must be bound with `propagate=true` and cannot be unbound. Constructors/destructors run via OPS dossiers so their progress is observable.

### Diagnostics, mailboxes, and CEI
- `/data/mailbox/diag` is seeded during bootstrap and acts as the default diagnostics mailbox. Mailboxes store messages under `msgs/<id>` plus metadata (`meta/policy`, `meta/runtime/expiries*`). Message IDs prefer caller input, fall back to envelope digests, then to counters to stay deterministic.
- TTL resolution merges message, mailbox, and topology scopes, computing beat and wallclock deadlines and recording the winning scope plus whether spacing analytics were involved. Retention planners read beat and wallclock buckets separately and report whether more work remains.
- CEI Facts contain severity (`sev:fatal|crit|usage|warn|debug`), topic, note, origin, optional subject link, beats/timestamps, and optional payload references. `cep_cei_emit()` can attach to OPS dossiers (closing them with `sts:fail` for `sev:crit` or `sev:fatal`) and optionally enqueue `sig_cei/<severity>` impulses. Fatal facts always trigger shutdown through the documented operation timeline.
- Severity mapping guidance: usage ⇒ misuse without shutdown, warn ⇒ tolerated anomaly, crit ⇒ integrity risk (auto shutdown), fatal ⇒ unrecoverable (immediate shutdown). Topics such as `control/prr`, `namepool.*`, and `transport/*` keep diagnostics searchable.

### Serialization, streaming, and replay
- Streams begin with a control chunk (magic `0x4345503000000000`, version, byte order, flags, metadata length, journal beat, optional capability bits). Capability flags advertise features such as history manifests, manifest deltas, payload fingerprints, proxy envelopes, digest trailers, split descriptors, and namepool translation maps. Readers reject bundles advertising unsupported capabilities.
- Chunk classes: control (`0x0000`), structure (`0x0001` base manifests/deltas, child descriptors), blob (`0x0002` payload slices), library (`0x0003` proxy snapshots). Chunk IDs reserve the top bits for class, middle bits for transaction ID, and low bits for sequence numbers so receivers can detect gaps.
- Base manifests encode organiser/storage hints, cell type, path length, child count, and child descriptors (domain, tag, glob flag, tombstone/veil/fingerprint flags, position). Deltas capture a single structural change plus journal beat and lineage references. Readers stage manifests veiled and only graft them after control chunks confirm completeness.
- Data chunks annotate payload kind, flags, journal beat, optional hash, datatype, inline size, total size, DT identifiers, and inline bytes. Proxy envelopes wrap adapter-defined metadata and optional ticket/payload bytes. Digest trailers optionally append algorithm and checksum for the full bundle.
- Integration workflow: build floating branches in memory, populate them, then graft them atomically as shown in `L0-INTEGRATION-GUIDE`. OPS/STATES helpers (start/state_set/await/close) keep long-running tasks observable; mailbox helpers keep backlog drains deterministic. Stream helpers must be used for HANDLE/STREAM payloads—direct `cep_cell_data()` is undefined for those types.

### Federation transports and organs
- Providers register once (`cep_fed_transport_register`), advertise capability bitmaps, and expose vtables for open/send/request_receive/close. The transport manager enumerates providers, mirrors metadata under `/net/transports/<id>/`, and seeds `/net/mounts`, `/net/peers`, and `/net/telemetry` via `configure_mount`.
- Mount schema stores `caps/required`, `caps/preferred`, `caps/upd_latest`, transport selections (`provider`, `prov_caps`, `upd_latest` flag), and telemetry counters (`ready_count`, `bp_count`, `fatal_count`, `last_mode`, `bp_flag`). Capability negotiation filters providers lacking required bits and respects preferred IDs when constraints are satisfied. `upd_latest` restricts mounts to unreliable transports that can drop stale payloads.
- Organs expose deterministic request dictionaries:
  - **Link**: `peer`, `mount`, `mode`, `local_node`, optional `pref_prov`, `allow_upd`, capability dictionaries. Validators write `state`, `provider`, and `error_note`, emit CEI topics (`tp_noprov`, `tp_schema`, etc.), and close mounts when requests are deleted.
  - **Mirror**: extends link schema with source peer/channel, bundle parameters (`beat_window`, `max_infl`, optional `commit_mode`, `resume_tok`), episodic integration (`bundle_seq`, `commit_beat`, `pend_resum`). Validators coordinate E³, enforce inflight limits, and publish CEI on timeouts or schema issues.
  - **Invoke**: routes remote enzyme submissions, enforces deadlines, and emits CEI on timeouts (`tp_inv_timeout`) or rejections (`tp_inv_reject`). Requests capture `peer`, `mount`, `local_node`, `pref_prov`, capability dictionaries, and optional beat deadlines.
- Telemetry and CEI mirror under `/net/peers/<peer>/ceh/<topic>` for diagnostics. Mock providers support deterministic tests, enabling dual-runtime harnesses without real transports.

### Developer workflow, integration practice, tuning, and roadmap
- Repository layout: `src/l0_kernel/cep_cell.*` (core), `src/l0_kernel/storage/*` (backends), `src/l0_kernel/cep_molecule.h` (utilities), `src/l0_kernel/stream/*` (adapters), `src/test/*` (munit suites). Follow deterministic coding conventions: assert preconditions, respect ownership, and prefer small inline helpers when safe.
- Integration steps: stage branches off-tree (`cep_cell_initialize_*`), populate them, attach via `cep_cell_add`/dictionary helpers, then finalize temporary shells. Never keep stale pointers across mutations; resolve paths each time.
- Testing guidance: rely on munit suites, re-run relevant tests after kernel changes, keep debug breadcrumbs under `meta/debug`, and remove them once investigations end. When running sanitizers, build separate ASAN and Valgrind variants; never stack Valgrind on ASAN.
- Performance tuning: choose the lightest payload/store combination, set enzyme registry capacity hints, size store buckets, avoid unnecessary reindexing, and prefer `_hard` updates when history is optional. Anti-patterns include repeated reindexing, using packed queues for sorted data, keeping enormous backlink sets, and recording history unnecessarily.
- Roadmap snapshot: bootstrap/identity and deterministic manipulation are complete; auto-ID hygiene, HANDLE/STREAM history, traversal telemetry, shadow cleanup, packed queue recycling, range queries, persistence hooks, and agency execution remain active focus/backlog items. Hybrid episode promotions/demotions already ship and need pack-level adoption. Upcoming milestones prioritize structural resilience, runtime telemetry, and extended stream helpers.
- Documentation hygiene: `DOCS-ORIENTATION-GUIDE.md` maps references by subsystem; update it whenever docs move. `DOCS-INDEX.md` tracks document status and should reflect any additions or removals so the inventory stays reliable.

### Legacy integration parallels for PL/SQL developers
- Cells and stores align with table rows and nested tables; `/data/**` mirrors schema-owned storage, `/rt/**` functions like a redo buffer, and `/cas/**` replaces external BLOB stores.
- Beats replace transactions: all staged work becomes visible in the next beat and no observer can access partial state mid-beat.
- Enzymes replace stored procedures bound to schema objects; register descriptors once and bind them to target subtrees. Heartbeat `sig_sys/init` replaces “startup triggers”.
- Diagnostics and logging flow through mailboxes and CEI rather than ad-hoc tables; think of `cep_cei_emit` as raising an exception with deterministic routing.
- Rendezvous was retired; long-running work should now model state in cells and rely on E³ or pack-level schedulers.

## Q&A
- **How do I ensure a new helper aligns with existing invariants?** Re-read the relevant design note (for example, serialization or heartbeat), extend unit tests covering that subsystem, and only then modify code. Design docs capture the rationale that must remain true after refactors.
- **When should I use `_hard` updates or deletion helpers?** Only when history retention is unnecessary (e.g., cache resets) or when GC has proven no links remain. Regular workflows should prefer append-only updates so past states remain reconstructable.
- **What is the correct path for long-running orchestration?** Model it as an OPS/STATES dossier (`op/*` for generic tasks, `op/ep` for episodes). Awaiters, continuations, and shutdown/PRR controls all rely on that machinery, so bespoke polls should be avoided.
- **How do I route diagnostics outside the default mailbox?** Pass a pack-owned mailbox root into `cep_cei_emit` or custom mailbox helpers. TTL resolution, retention planning, and CEI severity policies remain identical regardless of the mailbox location.
