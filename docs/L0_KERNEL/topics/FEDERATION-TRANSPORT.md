# L0 Topic: Federation Transport Manager

## Introduction
Federation mounts no longer wire transports by hand. The transport manager gives Layer 0 a single place to discover providers, negotiate capabilities, seed `/net` schema, and police `upd_latest` semantics. Treat it as the traffic controller between federation enzymes and whichever provider (TCP sockets, pipes, mock harnesses, future media) best fits a mount’s policy.

## Technical Details
- **Registry & discovery.** Providers register once via `cep_fed_transport_register()`, advertising caps and payload limits. The manager collects them through `cep_fed_transport_provider_enumerate()` and mirrors the catalogue under `/net/transports/<provider_id>/` so mounts, tools, and diagnostics can inspect capabilities without poking the runtime.
- **Mount schema.** `cep_fed_transport_manager_configure_mount()` ensures `/net/mounts/<peer>/<mode>/<mount>/` exists, populates `caps/required`, `caps/preferred`, the `caps/upd_latest` opt-in, and writes transport selections under `transport/` (`provider`, `prov_caps`, `upd_latest`). These nodes are always rebuilt on configure so stale provider data never survives a negotiation cycle.
- **Discovery & health organs.** The pack registers `org:net_discovery:vl` to sanity-check `/net/peers/<peer>/services/<service>/` (enforcing `mode`, `mount_path`, `local_node`, optional `provider`, and the `upd_latest` flag) and `org:net_health:vl` to guard `/net/telemetry/<peer>/<mount>/` (ready/backpressure/fatal counters, frame stats, and the active provider). Their destructors prune empty service, telemetry, and CEI branches so stale peers vanish once mounts disappear.
- **Telemetry counters.** Telemetry entries expose `ready_count`, `bp_count`, `fatal_count`, `frame_count`, `last_mode`, `last_sample`, `last_event`, and the current `bp_flag`. Validators enforce the types (text vs. `val/u64` vs. `val/bool`) so tooling can consume them without defensive casting.
- **Capability negotiation.** Required bits must be present. Preferred bits are scored to pick a winner (ties fall back to lexicographic provider IDs). When mounts allow `upd_latest`, the manager filters out providers that do not advertise `CEP_FED_TRANSPORT_CAP_UNRELIABLE` so only transports allowed to coalesce gauges remain eligible. A preferred provider override (`preferred_provider_id`) wins if it satisfies the contract.
- **Channel lifecycle.** `cep_fed_transport_manager_configure_mount()` opens the provider channel immediately using the persistent provider cell from `/net/transports/<id>/`. Mount callbacks receive inbound frames through the provider’s vtable and all events flow back through `cepFedTransportCallbacks`. `cep_fed_transport_manager_close()` closes channels but leaves schema intact so the mount can be reconfigured without re-seeding the tree.
- **`upd_latest` handling.** For unreliable transports the manager caches at most one droppable payload per channel. When providers report backpressure the latest `upd_latest` frame replaces the previous one. Ready events trigger a flush; stale gauges are discarded instead of queuing. Sending `upd_latest` across reliable transports yields a CEI warning because the manager cannot legally drop the payload.
- **CEI diagnostics.** Failure to find a provider, schema issues, send failures, backpressure, fatal events, and `upd_latest` misuse raise structured CEI facts with short-form topics (`tp_noprov`, `tp_schema`, `tp_catsync`, `tp_backpr`, `tp_sendfail`, `tp_fatal`, …). Each peer’s `/net/peers/<peer>/ceh/<topic>/` branch records the last severity/note/beat so tools and tests can assert on the manager’s health signals without trawling logs.
- **Link organ (`/net/organs/link`).** Requests live under `/net/organs/link/requests/<id>/` and are plain dictionaries. Required fields are `peer`, `mount`, `mode`, and `local_node` (all `text`). Optional knobs include `pref_prov`, `allow_upd` (`bool`), `deadline` (`val/u64`), and a `caps/` sub-dictionary with `required/` and `preferred/` boolean flags matching `CEP_FED_TRANSPORT_CAP_*`. The validator writes `state` (`pending`, `active`, `error`, `removed`), clears or fills `error_note`, records the selected `provider`, and keeps those fields in the request cell so tools can watch the mount lifecycle without traversing `/net/mounts/…`. The destructor flips `state` to `removed`, clears `provider/error_note`, and asks the transport manager to close the mount with `reason="link-request-destroy"`.
- **Mirror organ (`/net/organs/mirror`).** Mirror requests also sit under `/net/organs/mirror/requests/<id>/` and extend the link layout with the information the episodic engine needs to stage bundles:
  - `peer` / `mount` / `mode` / `local_node` mirror the link contract and identify the local mirror mount to configure.
  - `src_peer` and `src_chan` (`text`) specify which remote peer and publish-side mount feed bundle data.
  - `bundle/` is a dictionary that captures staging limits:
    - `beat_window` (`val/u32`) – how many beats form a bundle.
    - `max_infl` (`val/u16`) – how many bundles may be outstanding before backpressure is asserted.
    - `resume_tok` (`text`, optional) – opaque token the episodic engine can hand back to resume an interrupted mirror.
    - `commit_mode` (`text`, optional) – `stream`, `batch`, or `manual` depending on whether commits happen every bundle, after a swarm of bundles, or under explicit operator control.
  - `caps/` and `pref_prov` follow the link schema so mirrors can favour providers (for example, low-latency LAN transports).
  - The validator publishes the usual `state`, `provider`, and `error_note` plus mirror-specific status keys:
    - `bundle_seq` (`val/u64`) – highest bundle sequence the organ has committed.
    - `commit_beat` (`val/u64`) – beat of the most recent successful commit.
    - `pend_resum` (`text`, optional) – non-empty when the organ has paused and holds a new resume token for the caller.
  - On teardown the destructor closes the configured mount, clears the status fields, and deletes any `bundle/` progress nodes so subsequent requests start from a clean slate.
- **Stub providers.** The repository ships three providers: `tcp` (reliable remote stream semantics), `pipe` (reliable local IPC) and `mock` (unreliable in-process test harness). The mock provider keeps queues visible to tests via helpers in `fed_transport_providers.h` so suites can drive backpressure, inbound frames, and verify coalescing without real sockets.

## Q&A
- **How do I add a new provider?** Implement a `cepFedTransportProvider` with the `open/send/request_receive/close` vtable, register it via `cep_fed_transport_register()`, and seed `/net/transports/<id>/` using `cep_fed_transport_schema_seed_provider()` if you want static metadata in tree. The manager takes care of negotiation and mount schema updates.
- **Where do I inspect capability choices at runtime?** Resolve `/net/mounts/<peer>/<mode>/<mount>/transport/`. The `provider` value records the ID, `prov_caps/` mirrors the provider’s capability bits, and `caps/` captures the mount’s required/preferred contract.
- **How do I simulate inbound frames in tests?** Use the mock provider helpers (`cep_fed_transport_mock_enqueue_inbound`, `cep_fed_transport_mock_signal_ready`, `cep_fed_transport_mock_pop_outbound`). They queue payloads, trigger READY events, and expose outbound buffers without reaching into provider internals.
- **What happens when negotiation fails?** The manager emits a `transport/no_provider` CEI fact and leaves the mount unchanged. The mount branch remains available so external tools can display the failure while the caller retries with different caps or providers.
