# L2 Ecology Implementation Plan

This guide captures how to implement the L2 Ecology pack on today's L0 kernel and optional L1 coherence/pipeline pack. It distills the temporary L2 design/TODO notes into a durable plan so work can proceed in C without re-reading scattered drafts.

## Technical Details

- **Bootstrap/shutdown contract**: Provide `cep_l2_bootstrap()`/`cep_l2_shutdown()` that behave like other optional packs. Bootstrap probes L0 readiness, optionally detects L1 via feature flags, seeds `/data/eco` and `/data/learn`, registers idempotent organs/enzymes, seeds schemas under `/data/eco/schema/**`, and opens `op/l2_boot` with state evidence. Shutdown closes `op/l2_shdn`, stops new flow episodes, marks organisms cancelled/finished, flushes metrics, and never blocks kernel teardown even if L2 never started.
- **Organs and bindings**: Register organs `org:eco_root`, `org:eco_flows`, `org:eco_runtime`, and `org:learn_models` with ct/vl/dt handlers mirroring L1 patterns (idempotent registration, validation of existing descriptors). Bind Flow VM entrypoints (`sig_eco/flow_step`, `sig_eco/scheduler`) under pack roots; keep bindings deterministic and tombstone-safe.
- **Schema choices**: `/data/eco/**` holds species, variants, niches, guardians, flows, runtime organisms, decisions mirror, sched queues, and metrics; `/data/learn/**` holds parameter snapshots per species/variant/revision with provenance. Canonical IDs may mirror L1 beings/bonds/contexts. Append-only history applies to organism records and model revisions.
- **Flow VM runtime**: Node types Guard/Transform/Wait/Decide/Clamp share a compiled node table under each flow (`graph/nodes`). Execution runs inside E3 slices with budgets (`bud_cpu_ns`, `bud_io_by`), advancing organism `node_ptr` and updating metrics. Transform nodes call L0/L1 helpers (e.g., `sig_cell/*`, `org:flow_spec_l1`), never mutating L0 graphs directly, and can append model revisions under `/data/learn/models/**` with provenance. Wait nodes attach watchers (labels/rewards/pipeline stage events) and yield via `op/ep` await states. Decide nodes emit/consume Decision Cells with pipeline metadata into `/journal/decisions` plus `/data/eco/runtime/decisions`. Clamp nodes enforce guardian predicates and budgets, emitting CEI (`eco.guardian.violation`, `eco.limit.hit`) and closing episodes when configured.
- **Scheduler and triggers**: A scheduler enzyme scans L1 runtime triggers (`/data/flow/runtime/runs/**`) and app events for new work during Capture. It computes niches from contexts, selects species deterministically, chooses variants via Decide nodes when exploration is needed, opens `op/ep` dossiers with pipeline blocks, and creates `/data/eco/runtime/organisms/<id>` records (append-only) pointing at the dossier and selected variant. While L1 is present, the scheduler also leans on L1 helpers to GC/verify runs and roll up runtime metrics so pipeline state stays canonical.
- **Scheduler and metrics (implemented)**: The current scheduler seeds organisms per flow definition, opens `op/ep` dossiers with pipeline metadata, selects variants deterministically, and steps the Flow VM with a small per-beat budget. Metrics roll up per species/variant/niche/global (`org_started`, `flow_steps`, `org_finished`, `org_failed`, `org_waiting`), and runtime history entries mirror progress each beat.
- **Decision Cells and replay**: Use existing `cep_decision_cell_*` plumbing; key entries by flow/organism/node plus pipeline IDs. Normal runs record distribution + choice; replay looks up entries and fails loudly on mismatches. Cross-branch reads wrap `cep_cell_hydrate_for_enzyme`/`cep_l1_coh_hydrate_safe` and also log ecological context next to the Decision Cell entry for audit.
- **Guardians and clamp policy**: Guardian definitions live under `/data/eco/guardians/**` with scope (species/variant/niche), predicate spec, and action (hard-deny, soft-deny, escalate). Clamp nodes consult guardian results and E3 budgets, emit CEI with pipeline metadata, and set organism/episode status (`cancelled`/`failed`) per policy.
- **Persistence and branches**: Default branches `/data/eco` and `/data/learn` are durable; scheduled/on-demand allowed if policy demands. CPS persists staged work during Commit; organism histories and model revisions stay append-only, backed by runtime `history` and `decisions` ledgers. Cross-branch read guardrails remain in place, emit CEI (`cell.cross_read`) plus Decision Cells, and L2 mirrors ecological context into `/data/eco/runtime/decisions`.
- **Observability and metrics**: OPS dossiers for `op/l2_boot`, `op/l2_shdn`, and flow episodes carry pipeline metadata. CEI topics: `eco.guardian.violation`, `eco.limit.hit`, `eco.flow.error`, `eco.evolution.proposed`. Metrics roll up per species/variant/niche and globally; scheduler/VM publish beat-level counters for watchdogs. Diagnostics mailboxes should default to `/data/mailbox/diag` unless a pack-owned mailbox is provided. Runtime history entries record beat/pipeline/species/variant plus optional notes for replay.
- **Code/test layout**: Implementation resides in `src/l2_ecology/**`; Flow VM runtime and organs sit here. Tests live in `src/test/l2_ecology/**`, gated by `CEP_L2_TESTS` to avoid default suite bloat. Avoid touching `src/l0_kernel/**` and `docs/L0_KERNEL/**` unless cross-layer interfaces genuinely change.
- **Phased delivery (suggested)**:
  1. Bootstrap + roots + organs + schemas + OPS readiness/teardown.
  2. Flow VM core: Guard/Transform/Decide execution with Decision Cells + compiled graphs; scheduler stub starting organisms.
  3. Add Wait (watchers/await) and Clamp (budgets/guardians + CEI).
  4. Flesh out persistence/metrics surfaces and guardian policy plumbing.
  5. Integrate L1 helpers for pipeline edits/runtime triggers; align CEI with pipeline metadata.
  6. Harden replay paths and observability; document lexicon additions and finalize gating for `CEP_L2_TESTS`.

## Q&A

- **How does this stay compatible with the shipping kernel?** The pack consumes only public L0/L1 APIs, ships its own organs/enzymes under `src/l2_ecology`, and remains optional during boot/shutdown. No L0 rewrite is required.
- **What happens if L1 is missing?** The scheduler and Flow VM still run against L0 state but skip coherence/pipeline rewrites; species/variants/niches remain pack-local, and pipeline metadata blocks default to what the caller provides.
- **Which artifacts prove readiness?** `op/l2_boot` closing with `sts:ok`, `/data/eco/meta/state="ready"` (with beat/version), and deterministic CEI/OPS entries around guardian hits and Decision Cells give operators replayable evidence. `op/l2_shdn` mirrors shutdown progress without blocking kernel teardown.
