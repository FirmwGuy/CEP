# Layer 2 Ecology Pack Overview

Layer 2 ("L2 Ecology") turns CEP into a supervised learning ecosystem on top of the deterministic kernel and optional L1 coherence/pipeline pack. This note explains what the pack is for, how it fits with existing layers, and where its code and tests live so contributors can land it without surprising the kernel or L1.

## Technical Details

- **Role and dependencies**: Optional pack that never blocks kernel boot/shutdown. Hard dependency on L0 (heartbeat, OPS/E3, CPS/CAS, CEI, pipeline metadata). Soft dependency on L1 (coherence + pipeline graphs); when L1 is absent, L2 skips graph rewrites and beings/bonds but still runs flows against L0 state.
- **Data roots**: Pack-owned namespaces under `/data/eco/**` (species, variants, niches, guardians, flows, runtime organisms, metrics, history/decisions) and `/data/learn/**` (parameter snapshots per species/variant with provenance). L2 uses L1's `/data/flow/**` and `/data/coh/**` when available; it never mutates L0 roots directly.
- **Ecology model**: Species group related tactics; variants are selectable implementations; niches route contexts to variants; guardians encode invariants; organisms are per-context Flow executions; flows belong to species and reference the Flow VM graph. Canonical IDs can mirror L1 beings/bonds/contexts so adjacency and provenance stay L1-driven.
- **Flow VM semantics**: Deterministic node types Guard/Transform/Wait/Decide/Clamp executed inside E3 episodes. Guard reads state; Transform stages L0/L1 mutations; Wait yields via watchers (labels, rewards, timeouts, pipeline triggers); Decide chooses among finite actions using Decision Cells (with replay parity); Clamp enforces budgets/guardians and emits CEI on violations. The current implementation compiles `graph/nodes` into runnable tables, records decisions under `/journal/decisions` plus `/data/eco/runtime/decisions`, enforces clamp budgets (`eco.limit.hit`) and guardian actions (`eco.guardian.violation`), and can append model revisions under `/data/learn/models/**`.
- **Runtime rhythm**: Scheduler scans L1 runtime triggers and app events during Capture, instantiates organisms + `op/ep` dossiers with pipeline metadata, and steps flows during Compute with per-slice budgets. Commit publishes staged cells so replay stays deterministic beat-to-beat. Metrics roll up per species/variant/niche/global (`org_started`, `flow_steps`, `org_finished`, `org_failed`, `org_waiting`) and runtime history entries record each beatâ€™s progress.
- **Hydration and observability**: Cross-branch hydrations wrap `cep_l1_coh_hydrate_safe` when available, logging risk + pipeline/species/variant context into `/data/eco/runtime/decisions`. CEI topics include `eco.flow.error` (compile/runtime faults), `eco.guardian.violation` (guardian/clamp denials), `eco.limit.hit` (budget ceilings), and `eco.evolution.proposed` (new organism/variant pairings).
- **Decision Cells and replay**: All non-deterministic choices (policy picks, risky cross-branch reads) emit Decision Cells keyed by flow/organism/node plus pipeline IDs. Replay consumes the ledger instead of re-sampling and fails loudly if entries mismatch.
- **Guardians and safety**: Guardian predicates scope to species/variants/niches and enforce resource/fairness/safety envelopes. Clamp nodes consult guardian results and E3 budgets, emitting CEI topics such as `eco.guardian.violation`/`eco.limit.hit` and marking organisms or episodes failed when configured.
- **Security/federation alignment**: Flow episodes and CEI facts carry pipeline metadata. Remote invokes go through L1/federation helpers so enclave policy (`sec.*` CEI) and pipeline approvals apply uniformly. Cross-branch reads use `cep_cell_hydrate_for_enzyme`/`cep_l1_coh_hydrate_safe` and record Decision Cells for replay.
- **Persistence and metrics**: `/data/eco` and `/data/learn` follow CPS policy (durable branches by default). Runtime history/decisions are append-only; model updates are new revisions with provenance. Metrics roll up per species/variant/niche plus global counters. Observability mirrors through OPS (`op/l2_boot`, `op/l2_shdn`, flow episodes) and CEI topics.
- **Code layout**: Pack implementation lives under `src/l2_ecology/**`; tests under `src/test/l2_ecology/**` (gated by `CEP_L2_TESTS`). Documentation for the pack resides in `docs/L2_ECOLOGY/**`; keep README/index in sync when adding new notes.

## Q&A

- **Does L2 require L1?** No. With L1 absent, L2 skips coherence/pipeline edits and runs flows against L0 state; with L1 present, it relies on L1 helpers for graph changes and context routing.
- **How is determinism preserved during learning?** Policy choices and cross-branch reads emit Decision Cells; model updates are append-only snapshots with provenance. Replay reuses the ledger and snapshots instead of re-sampling or re-training.
- **Where should new code and tests land?** Implementation belongs in `src/l2_ecology/**` and tests in `src/test/l2_ecology/**`; avoid touching L0/L1 directories unless explicitly coordinating cross-layer helpers. Documentation updates live in `docs/L2_ECOLOGY/**` and the orientation guide.
